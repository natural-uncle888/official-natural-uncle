<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Natural Uncleï½œä½¿ç”¨è€…å›é¥‹å¯©æ ¸ï¼ˆCloudinary ç‰ˆï¼‹æŠ˜æ‰£ç¢¼ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji,Helvetica Neue,Arial,"Noto Sans",sans-serif}</style>
</head>
<body class="bg-emerald-50/30 text-gray-900">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <div class="flex items-center gap-3">
      <img src="https://res.cloudinary.com/dvz4druzc/image/upload/v1760272564/upscaled_no_bg_po1xtb.png" class="h-8" alt="Natural Uncle">
      <h1 class="text-2xl font-bold">ä½¿ç”¨è€…å›é¥‹å¯©æ ¸</h1>
    </div>
    <p class="text-sm text-gray-600 mt-1">Cloudinary ç‰ˆè³‡æ–™çµæ§‹ï¼ˆnickname / content / stars / images[] / emailï¼‰ã€‚éœ€æ–¼ Netlify è¨­å®š <code>ADMIN_KEY</code>ã€Cloudinaryã€Brevoã€‚</p>

    <div class="mt-6 flex flex-wrap gap-2 items-center">
      <input id="adminKey" type="password" class="border rounded px-3 py-2 w-64" placeholder="è¼¸å…¥ç®¡ç†é‡‘é‘°">
      <button id="btnSaveKey" class="px-3 py-2 rounded border">å„²å­˜é‡‘é‘°</button>
      <div class="ml-auto flex gap-2">
        <button data-tab="pending" class="tab px-3 py-2 rounded bg-emerald-600 text-white">å¾…å¯©æ ¸</button>
        <button data-tab="approved" class="tab px-3 py-2 rounded border">å·²é€šé</button>
        <button data-tab="rejected" class="tab px-3 py-2 rounded border">å·²é€€å›</button>
      </div>
    </div>

    <div class="mt-4 flex items-center gap-2">
      <button id="btnReload" class="px-4 py-2 rounded bg-emerald-600 text-white">é‡æ–°è¼‰å…¥</button>
      <div class="text-xs text-gray-600">APIï¼š/.netlify/functions/reviewsã€/.netlify/functions/coupons</div>
    </div>

    <div id="list" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6"></div>
  </div>

<script>
const API_REVIEWS = '/.netlify/functions/reviews';
const API_COUPONS = '/.netlify/functions/coupons';
const COUPON_CODE = 'NATURAL200';

// === Admin Key ===
(function initKey(){
  const saved = localStorage.getItem('ADMIN_KEY') || '';
  const el = document.getElementById('adminKey');
  if (saved) el.value = saved;
  document.getElementById('btnSaveKey').addEventListener('click', ()=>{
    const v = el.value.trim();
    if (!v) { alert('è«‹è¼¸å…¥ç®¡ç†é‡‘é‘°'); return; }
    localStorage.setItem('ADMIN_KEY', v);
    alert('å·²å„²å­˜ç®¡ç†é‡‘é‘°');
  });
})();

// === Helpers ===
async function req(url, options={}){
  const r = await fetch(url, options);
  let data = null; try{ data = await r.json(); } catch(e){ data = { error: await r.text() } }
  if (!r.ok) throw new Error(data?.error || 'Request failed');
  return data;
}
function fmt(ts){ return ts ? new Date(ts).toLocaleString('zh-TW') : ''; }
function star5(n=5){ n = Math.max(1, Math.min(5, parseInt(n||5,10))); return 'â˜…'.repeat(n); }
function esc(s){ return String(s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",
  ">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

// === Tabs ===
let currentTab = 'pending';
function setActiveTab(t){
  currentTab = t;
  document.querySelectorAll('.tab').forEach(btn=>{
    if (btn.dataset.tab === t){ btn.className = 'tab px-3 py-2 rounded bg-emerald-600 text-white'; }
    else { btn.className = 'tab px-3 py-2 rounded border'; }
  });
}

// === Load Reviews ===
async function loadReviews(){
  const data = await req(`${API_REVIEWS}?status=${encodeURIComponent(currentTab)}&perPage=50`);
  renderList(data.items || []);
}

// === Ensure Coupon exists (init once) ===
async function ensureCoupon(){
  const key = localStorage.getItem('ADMIN_KEY')||'';
  if (!key) return; // è‹¥å°šæœªè¼¸å…¥é‡‘é‘°å°±ç•¥é
  try{
    await req(`${API_COUPONS}?action=init`, { method:'POST', headers:{ 'Authorization': 'Bearer '+key } });
  } catch(e) { /* already exists or no key */ }
}

// === Actions ===
async function doApprove(id){
  const key = localStorage.getItem('ADMIN_KEY')||'';
  if (!key) return alert('è«‹å…ˆè¼¸å…¥ä¸¦å„²å­˜ç®¡ç†é‡‘é‘°');
  await req(API_REVIEWS, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+key }, body: JSON.stringify({ id, action:'approve' }) });
  alert('å·²é€šé');
  await loadReviews();
}
async function doReject(id){
  const key = localStorage.getItem('ADMIN_KEY')||'';
  if (!key) return alert('è«‹å…ˆè¼¸å…¥ä¸¦å„²å­˜ç®¡ç†é‡‘é‘°');
  await req(API_REVIEWS, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+key }, body: JSON.stringify({ id, action:'reject' }) });
  alert('å·²é€€å›');
  await loadReviews();
}
async function doDelete(id){
  const key = localStorage.getItem('ADMIN_KEY')||'';
  if (!key) return alert('è«‹å…ˆè¼¸å…¥ä¸¦å„²å­˜ç®¡ç†é‡‘é‘°');
  if (!confirm('ç¢ºå®šåˆªé™¤é€™å‰‡è©•è«–ï¼Ÿ')) return;
  await req(`${API_REVIEWS}?id=${encodeURIComponent(id)}`, { method:'DELETE', headers:{ 'Authorization':'Bearer '+key } });
  alert('å·²åˆªé™¤');
  await loadReviews();
}

async function sendCoupon(email){
  const key = localStorage.getItem('ADMIN_KEY')||'';
  if (!key) return alert('è«‹å…ˆè¼¸å…¥ä¸¦å„²å­˜ç®¡ç†é‡‘é‘°');
  if (!email) return alert('æ­¤è©•è«–æ²’æœ‰ Emailï¼Œè«‹æ”¹ç”¨ã€Œè¤‡è£½æŠ˜æ‰£ç¢¼ã€å¾Œä»¥ LINE å‚³é€');
  await req(`${API_COUPONS}?action=send`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+key }, body: JSON.stringify({ email }) });
  alert('æŠ˜æ‰£ç¢¼å·²å¯„å‡º');
}
async function copyCoupon(){
  const info = await req(`${API_COUPONS}?code=${encodeURIComponent(COUPON_CODE)}`);
  if (!info.valid) return alert('æŠ˜æ‰£ç¢¼ç„¡æ•ˆæˆ–å·²éæœŸ');
  const expireStr = new Date(info.expireAt).toLocaleDateString('zh-TW');
  const text = `æ‚¨çš„å›é¥‹æŠ˜æ‰£ç¢¼ï¼š${info.code}
å„ªæƒ å…§å®¹ï¼šæŠ˜æŠµ NT$${info.amount}
ä½¿ç”¨æ–¹å¼ï¼šåˆ°åº—çµå¸³å‡ºç¤ºæ­¤æŠ˜æ‰£ç¢¼å³å¯
æœ‰æ•ˆæœŸé™ï¼š${expireStr} å‰
ï¼ˆæœ¬åº—ä¿ç•™ä¿®æ”¹ã€è®Šæ›´ã€æš«åœæˆ–çµ‚æ­¢æ´»å‹•ä¹‹æ¬Šåˆ©ï¼‰`;
  await navigator.clipboard.writeText(text);
  alert('å·²è¤‡è£½æŠ˜æ‰£ç¢¼å…§å®¹ï¼Œè«‹è²¼åˆ° LINE');
}

// === Render ===
function renderList(items){
  const list = document.getElementById('list');
  list.innerHTML = '';
  if (!items.length){
    list.innerHTML = '<div class="text-sm text-gray-500">ç›®å‰æ²’æœ‰è³‡æ–™</div>';
    return;
  }
  for (const it of items){
    const card = document.createElement('article');
    card.className = 'bg-white rounded-2xl border p-4';

    // Images (1-3)
    const grid = document.createElement('div');
    grid.className = 'grid gap-3';
    const imgs = Array.isArray(it.images) ? it.images.slice(0,3) : (it.image ? [it.image] : []);
    for (const url of imgs){
      const img = document.createElement('img');
      img.src = url; img.alt = 'review image';
      img.className = 'w-full aspect-[4/3] object-cover rounded-lg border';
      grid.appendChild(img);
    }
    if (imgs.length) card.appendChild(grid);

    const meta = document.createElement('div');
    meta.className = 'mt-3 text-sm text-gray-500';
    meta.textContent = fmt(it.createdAt);

    const title = document.createElement('div');
    title.className = 'mt-1 font-semibold';
    title.textContent = `${it.nickname || 'åŒ¿å'} ãƒ» ${star5(it.stars)}`;

    const content = document.createElement('p');
    content.className = 'mt-2 text-gray-700';
    content.textContent = it.content || '';

    const email = document.createElement('div');
    if (it.email){
      email.className = 'mt-1 text-xs text-gray-500';
      email.textContent = `Emailï¼š${it.email}`;
    }

    const row = document.createElement('div');
    row.className = 'mt-3 flex items-center gap-2 flex-wrap';

    if (currentTab === 'pending'){
      row.appendChild(btn('é€šé', ()=>doApprove(it.id), 'bg-emerald-600 text-white'));
      row.appendChild(btn('é€€å›', ()=>doReject(it.id)));
      row.appendChild(btn('åˆªé™¤', ()=>doDelete(it.id)));
    } else if (currentTab === 'approved'){
      row.appendChild(btn('âœ‰ å¯„æŠ˜æ‰£ç¢¼', ()=>sendCoupon(it.email), 'bg-emerald-600 text-white'));
      row.appendChild(btn('ğŸ“‹ è¤‡è£½æŠ˜æ‰£ç¢¼', ()=>copyCoupon()));
      row.appendChild(btn('åˆªé™¤', ()=>doDelete(it.id)));
    } else { // rejected
      row.appendChild(btn('é€šé', ()=>doApprove(it.id), 'bg-emerald-600 text-white'));
      row.appendChild(btn('åˆªé™¤', ()=>doDelete(it.id)));
    }

    card.appendChild(meta);
    card.appendChild(title);
    card.appendChild(content);
    if (it.email) card.appendChild(email);
    card.appendChild(row);
    list.appendChild(card);
  }
}

function btn(text, onClick, extraClass=''){
  const b = document.createElement('button');
  b.className = `px-3 py-1.5 rounded border text-sm ${extraClass}`.trim();
  b.textContent = text;
  b.addEventListener('click', onClick);
  return b;
}

// === Events ===
Array.from(document.querySelectorAll('.tab')).forEach(el=>{
  el.addEventListener('click', ()=>{
    setActiveTab(el.dataset.tab);
    loadReviews();
  })
});

document.getElementById('btnReload').addEventListener('click', ()=> loadReviews());

// Boot
setActiveTab('pending');
ensureCoupon().then(loadReviews);
</script>
</body>
</html>
