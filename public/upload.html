<!doctype html>
<html lang="zh-Hant">
<head>
<link rel="icon" type="image/png" href="https://res.cloudinary.com/dijzndzw2/image/upload/v1757176751/logo-3_hddq08.png"/>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>感謝您讓我們服務｜分享這次成果照</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji,Helvetica Neue,Arial,"Noto Sans",sans-serif}</style>
</head>
<body class="bg-white text-gray-900">
  <div class="max-w-xl mx-auto px-4 py-10">
    <div class="flex items-center gap-3">
      <img src="https://res.cloudinary.com/dvz4druzc/image/upload/v1760272564/upscaled_no_bg_po1xtb.png" class="h-8" alt="Natural Uncle">
      <div class="font-semibold">Natural Uncle</div>
    </div>

    <h1 class="mt-6 text-2xl font-bold">感謝您讓我們服務</h1>
    <p class="mt-2 text-gray-600 text-sm">完成服務的 14 天內可投稿。審核通過將贈 <strong>$100 回饋折抵</strong>（不限評分）。</p>

    <form id="frm" class="mt-6 grid gap-4">
      <input type="hidden" id="token" name="token">
      <div>
        <label class="block text-sm text-gray-600">您的稱呼（顯示為：姓氏＋先生/小姐）</label>
        <input id="name" class="mt-1 w-full border rounded px-3 py-2" placeholder="例如：林先生 / 陳小姐" required>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-gray-600">地區</label>
          <input id="area" class="mt-1 w-full border rounded px-3 py-2" placeholder="例如：台中市・西屯區" required>
        </div>
        <div>
          <label class="block text-sm text-gray-600">服務項目</label>
          <input id="service" class="mt-1 w-full border rounded px-3 py-2" placeholder="例如：冷氣清洗" required>
        </div>
      </div>
      <div>
        <label class="block text-sm text-gray-600">評分</label>
        <select id="rating" class="mt-1 w-full border rounded px-3 py-2">
          <option value="5">★★★★★（非常滿意）</option>
          <option value="4">★★★★☆</option>
          <option value="3">★★★☆☆</option>
          <option value="2">★★☆☆☆</option>
          <option value="1">★☆☆☆☆</option>
        </select>
      </div>
      <div>
        <label class="block text-sm text-gray-600">您的心得（30–200 字）</label>
        <textarea id="comment" class="mt-1 w-full border rounded px-3 py-2" rows="4" maxlength="400" placeholder="分享這次的感受、服務體驗或改變～" required></textarea>
      </div>
      <div>
        <label class="block text-sm text-gray-600">照片（必須 1–2 張，建議 4:3）</label>
        <input id="images" type="file" accept="image/*" multiple class="mt-1 w-full border rounded px-3 py-2" required>
        <p class="mt-1 text-xs text-gray-500">＊為保護隱私，請避免包含可辨識的人臉或個資；系統會自動移除 EXIF 並加浮水印。</p>
      </div>
      <div>
        <label class="block text-sm text-gray-600">Email（選填，用於寄送折抵碼）</label>
        <input id="email" type="email" class="mt-1 w-full border rounded px-3 py-2" placeholder="若不填，通過後也可由 LINE 通知">
      </div>
      <div class="text-xs text-gray-500">
        送出即表示您同意我們以店家指定之內容形式公開展示投稿，並保留調整與終止之權利；不以評分高低作為公開或回饋之唯一標準；若需撤下投稿，請透過下架申請與我們聯繫。
      </div>

      <button class="mt-2 px-4 py-2 rounded bg-emerald-600 text-white">送出投稿</button>
    </form>

    <div id="ok" class="hidden mt-8 p-4 rounded bg-emerald-50 border border-emerald-200 text-emerald-800">
      已收到！我們會在 1–2 個工作天內審核並回覆，通過後會發送折抵碼。謝謝您的分享！
    </div>
  </div>

<script>
const API = '/.netlify/functions/reviews';
function qs(id){ return document.getElementById(id); }

// 讀取 URL token
const url = new URL(location.href);
qs('token').value = url.searchParams.get('r') || '';

// 將圖片 File 轉為 dataURL（base64）送往後端，後端會上傳到 Cloudinary + 套浮水印
function fileToDataURL(file){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

document.getElementById('frm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const files = qs('images').files;
  if (!files || files.length < 1 || files.length > 2) {
    return alert('請選擇 1–2 張與本次服務相關之照片');
  }
  const images = [];
  for (let i=0;i<files.length;i++){
    const dataUrl = await fileToDataURL(files[i]);
    images.push(dataUrl);
  }

  const payload = {
    token: qs('token').value,
    name: qs('name').value.trim(),
    area: qs('area').value.trim(),
    service: qs('service').value.trim(),
    rating: qs('rating').value,
    comment: qs('comment').value.trim(),
    images,
    email: qs('email').value.trim()
  };

  const res = await fetch(API, {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if (!res.ok) return alert(data.error || '提交失敗');

  qs('frm').classList.add('hidden');
  qs('ok').classList.remove('hidden');
});
</script>
</body>
</html>
