<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Natural Uncleï½œå›é¥‹æŠ•ç¨¿ï¼ˆCloudinary ç‰ˆï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji,Helvetica Neue,Arial,"Noto Sans",sans-serif}
    .dropzone.dragover{border-color:#059669;background-color:#ecfdf5}
  </style>
</head>
<body class="bg-emerald-50/30 text-gray-900">
  <header class="max-w-3xl mx-auto px-4 pt-8">
    <div class="flex items-center gap-3">
      <img src="https://res.cloudinary.com/dvz4druzc/image/upload/v1760272564/upscaled_no_bg_po1xtb.png" class="h-9" alt="Natural Uncle" />
      <h1 class="text-2xl font-bold">å›é¥‹æŠ•ç¨¿</h1>
    </div>
    <p class="text-sm text-gray-600 mt-1">åˆ†äº«æ‚¨çš„ä½¿ç”¨å¿ƒå¾—ï¼ˆå¯ä¸Šå‚³ 1â€“3 å¼µåœ–ç‰‡ï¼‰ã€‚é€šéå¯©æ ¸å¾Œï¼Œæ‚¨å°‡æ”¶åˆ° NT$200 å›é¥‹æŠ˜æ‰£ç¢¼ã€‚</p>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-8">
    <section id="card" class="bg-white rounded-2xl shadow-sm border p-6">
      <form id="form" class="space-y-5">
        <!-- Honeypot (anti-spam) -->
        <input type="text" name="company" autocomplete="off" tabindex="-1" class="hidden" aria-hidden="true" />

        <div>
          <label class="block text-sm font-medium">æš±ç¨±ï¼ˆå¿…å¡«ï¼‰</label>
          <input id="nickname" type="text" required class="mt-1 w-full border rounded px-3 py-2" placeholder="æ‚¨çš„æš±ç¨±" />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">Emailï¼ˆé¸å¡«ï¼Œç”¨æ–¼å¯„é€æŠ˜æ‰£ç¢¼ï¼‰</label>
            <input id="email" type="email" class="mt-1 w-full border rounded px-3 py-2" placeholder="example@email.com" />
          </div>
          <div>
            <label class="block text-sm font-medium">è©•åˆ†ï¼ˆ1â€“5ï¼‰</label>
            <select id="stars" class="mt-1 w-full border rounded px-3 py-2">
              <option value="5">â˜…â˜…â˜…â˜…â˜… éå¸¸æ»¿æ„</option>
              <option value="4">â˜…â˜…â˜…â˜… æ»¿æ„</option>
              <option value="3">â˜…â˜…â˜… æ™®é€š</option>
              <option value="2">â˜…â˜… ä¸æ»¿æ„</option>
              <option value="1">â˜… éå¸¸ä¸æ»¿æ„</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium">å¿ƒå¾—å…§å®¹ï¼ˆå¿…å¡«ï¼‰</label>
          <textarea id="content" rows="5" required class="mt-1 w-full border rounded px-3 py-2" placeholder="è«‹åˆ†äº«æ‚¨çš„ä½¿ç”¨é«”é©—èˆ‡æƒ³æ³•â€¦"></textarea>
          <p class="text-xs text-gray-500 mt-1">è«‹é¿å…å€‹è³‡èˆ‡ä¸é›…å…§å®¹ã€‚</p>
        </div>

        <!-- Images uploader (1â€“3) -->
        <div>
          <label class="block text-sm font-medium">åœ–ç‰‡ä¸Šå‚³ï¼ˆé¸å¡«ï¼Œæœ€å¤š 3 å¼µï¼Œæ¯å¼µä¸Šé™ 5MBï¼‰</label>
          <div id="dropzone" class="dropzone mt-2 rounded-2xl border border-dashed p-4 bg-white text-center cursor-pointer">
            <p class="text-sm text-gray-600">æ‹–æ›³åœ–ç‰‡åˆ°æ­¤è™•ï¼Œæˆ–é»æ“Šé¸æ“‡</p>
            <input id="fileInput" type="file" accept="image/*" multiple class="hidden" />
          </div>
          <div id="preview" class="mt-3 grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
        </div>

        <div class="flex items-center justify-between">
          <div class="text-xs text-gray-500">é€å‡ºå³ä»£è¡¨æ‚¨åŒæ„æœ¬ç¶²ç«™é¡¯ç¤ºæ‚¨çš„æš±ç¨±èˆ‡å…§å®¹ï¼ˆé€šéå¯©æ ¸å¾Œï¼‰ã€‚</div>
          <button id="submitBtn" class="px-4 py-2 rounded bg-emerald-600 text-white">é€å‡ºå›é¥‹</button>
        </div>
      </form>
    </section>

    <!-- Success Panel -->
    <section id="success" class="hidden bg-white rounded-2xl shadow-sm border p-6 text-center">
      <div class="mx-auto w-14 h-14 rounded-full bg-emerald-100 flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 text-emerald-600"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-2.59a.75.75 0 1 0-1.22-.92l-3.476 4.605-1.64-1.64a.75.75 0 1 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.13-.09l4.076-5.265Z" clip-rule="evenodd" /></svg>
      </div>
      <h2 class="text-xl font-semibold mt-4">æ„Ÿè¬æ‚¨çš„å›é¥‹ï¼</h2>
      <p class="text-gray-700 mt-2">æˆ‘å€‘å·²æˆåŠŸæ”¶åˆ°æ‚¨çš„åˆ†äº« ğŸ’š æ‚¨çš„å¿ƒå¾—å°‡åœ¨å¯©æ ¸å¾Œå…¬é–‹ã€‚</p>
      <div class="mt-3 p-3 bg-emerald-50 rounded-lg text-sm">
        ğŸ è‹¥é€šéå¯©æ ¸ï¼Œæ‚¨å°‡ç²å¾— <b>NT$200</b> å›é¥‹æŠ˜æ‰£ç¢¼ï¼Œå¯æ–¼ç¾å ´æœå‹™çµå¸³æ™‚ä½¿ç”¨ã€‚
      </div>
      <div class="mt-6 flex items-center justify-center gap-3">
        <a href="https://natural-uncle-official.netlify.app/" class="px-4 py-2 rounded border">è¿”å›é¦–é </a>
        <a href="https://line.me/R/ti/p/@uncle888" target="_blank" class="px-4 py-2 rounded bg-emerald-600 text-white">LINE è¯çµ¡æˆ‘å€‘</a>
      </div>
    </section>
  </main>

  <script>
  const API_REVIEWS = '/.netlify/functions/reviews';
  const MAX_FILES = 3;
  const MAX_BYTES = 5 * 1024 * 1024; // 5MB/å¼µ

  const form = document.getElementById('form');
  const submitBtn = document.getElementById('submitBtn');
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const preview = document.getElementById('preview');

  let files = [];

  // åŸºæœ¬ååƒåœ¾ï¼šé˜²é€£é» + ç°¡å–®é€Ÿç‡é™åˆ¶
  function canSubmit(){
    const last = parseInt(localStorage.getItem('last_submit_ts')||'0',10);
    return Date.now() - last > 10_000; // 10 ç§’
  }
  function markSubmit(){ localStorage.setItem('last_submit_ts', String(Date.now())); }

  // Dropzone äº’å‹•
  dropzone.addEventListener('click', ()=> fileInput.click());
  dropzone.addEventListener('dragover', e=>{ e.preventDefault(); dropzone.classList.add('dragover'); });
  dropzone.addEventListener('dragleave', ()=> dropzone.classList.remove('dragover'));
  dropzone.addEventListener('drop', e=>{
    e.preventDefault(); dropzone.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
  });
  fileInput.addEventListener('change', e=> handleFiles(e.target.files));

  function handleFiles(list){
    const arr = Array.from(list||[]);
    for (const f of arr){
      if (!f.type.startsWith('image/')) continue;
      if (f.size > MAX_BYTES){ alert('æœ‰åœ–ç‰‡è¶…é 5MB ä¸Šé™'); continue; }
      if (files.length >= MAX_FILES){ alert('æœ€å¤šä¸Šå‚³ 3 å¼µåœ–ç‰‡'); break; }
      files.push(f);
    }
    renderPreview();
  }

  function renderPreview(){
    preview.innerHTML = '';
    files.forEach((f, idx)=>{
      const url = URL.createObjectURL(f);
      const wrap = document.createElement('div');
      wrap.className = 'relative';
      const img = document.createElement('img');
      img.src = url; img.alt = 'upload';
      img.className = 'w-full aspect-[4/3] object-cover rounded-lg border';
      const rm = document.createElement('button');
      rm.type = 'button';
      rm.className = 'absolute top-2 right-2 bg-white/90 hover:bg-white border rounded-full w-8 h-8 flex items-center justify-center shadow';
      rm.innerHTML = '<span class="sr-only">ç§»é™¤</span>Ã—';
      rm.addEventListener('click', ()=>{ files.splice(idx,1); renderPreview(); });
      wrap.appendChild(img); wrap.appendChild(rm);
      preview.appendChild(wrap);
    });
  }

  async function toDataURL(file){
    return new Promise((resolve, reject)=>{
      const fr = new FileReader();
      fr.onload = ()=> resolve(fr.result);
      fr.onerror = reject;
      fr.readAsDataURL(file);
    })
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();

    // honeypot
    if (form.company && form.company.value){ return; }

    if (!canSubmit()){
      alert('é€å‡ºå¤ªé »ç¹ï¼Œè«‹ç¨å€™å†è©¦');
      return;
    }

    const nickname = document.getElementById('nickname').value.trim();
    const email = document.getElementById('email').value.trim();
    const content = document.getElementById('content').value.trim();
    const stars = parseInt(document.getElementById('stars').value, 10) || 5;

    if (!nickname || !content){
      alert('è«‹å¡«å¯«æš±ç¨±èˆ‡å¿ƒå¾—å…§å®¹');
      return;
    }

    submitBtn.disabled = true; submitBtn.textContent = 'é€å‡ºä¸­â€¦';

    try{
      // è½‰ dataURLï¼ˆ1â€“3 å¼µï¼‰
      const imagesData = [];
      for (const f of files){ imagesData.push(await toDataURL(f)); }

      const payload = { nickname, content, stars, email: email||null, imagesData };
      const r = await fetch(API_REVIEWS, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      if (!r.ok){ throw new Error(data?.error || 'æäº¤å¤±æ•—'); }

      // æˆåŠŸ
      markSubmit();
      document.getElementById('card').classList.add('hidden');
      document.getElementById('success').classList.remove('hidden');

    } catch(err){
      console.error(err);
      alert(err.message || 'ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      submitBtn.disabled = false; submitBtn.textContent = 'é€å‡ºå›é¥‹';
    }
  });
  </script>
</body>
</html>
