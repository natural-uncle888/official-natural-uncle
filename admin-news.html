<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>最新消息｜公告管理</title>
  <!-- Tailwind CDN（開發/內部工具可用；上線請改用編譯版） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 讓 bullets 每行正常顯示圓點 */
    ul li {
      display: list-item;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">最新消息｜公告管理</h1>

    <!-- Action Bar -->
    <div class="flex flex-wrap gap-2 items-center mb-4">
      <button id="btn-load" class="px-4 py-2 rounded bg-slate-900 text-white hover:bg-slate-800">從伺服器載入 /news.json</button>

      <label class="px-4 py-2 rounded bg-white border cursor-pointer hover:bg-slate-100">
        從本機匯入 JSON
        <input id="file-input" type="file" accept="application/json" class="hidden" />
      </label>

      <button id="btn-add" class="px-4 py-2 rounded bg-white border hover:bg-slate-100">新增一筆</button>
      <button id="btn-download" class="px-4 py-2 rounded bg-white border hover:bg-slate-100">下載 news.json</button>

      <button id="btn-upload-toggle" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-500" aria-expanded="false" aria-controls="gh-panel">上傳到 GitHub</button>

      <span id="dirty-ind" class="ml-2 text-xs text-amber-600 hidden">有未儲存變更</span>
    </div>
    <!-- GitHub Settings Panel -->
    <div id="gh-panel" class="hidden p-4 bg-white rounded-xl border mb-6">
      <div class="flex items-center justify-between mb-3">
        <div class="text-base font-semibold">上傳設定</div>
        <button id="btn-upload-close" class="text-sm text-slate-500 hover:underline">隱藏</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
        <div>
          <label class="block text-sm font-medium mb-1">Owner</label>
          <input id="gh-owner" class="w-full border rounded px-2 py-1" placeholder="your-org-or-user" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Repo</label>
          <input id="gh-repo" class="w-full border rounded px-2 py-1" placeholder="your-repo" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Branch</label>
          <input id="gh-branch" class="w-full border rounded px-2 py-1" placeholder="main" value="main" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Path</label>
          <input id="gh-path" class="w-full border rounded px-2 py-1" placeholder="news.json" value="news.json" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">GitHub Token (PAT)</label>
          <div class="relative">
            <input id="gh-token" type="password" class="w-full border rounded px-2 py-1 pr-10" placeholder="ghp_... 或 fine-grained" />
            <button type="button" id="toggle-token" class="absolute right-2 top-1/2 -translate-y-1/2 text-sm text-blue-600 hover:underline">顯示</button>
          </div>
        </div>
        <div class="md:col-span-5 flex items-center gap-3">
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="remember-settings" type="checkbox" class="border rounded" /> 記住以上設定（不含 Token）
          </label>
          <button id="btn-upload" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-500">執行上傳</button>
          <span id="gh-status" class="text-sm text-slate-600" aria-live="polite"></span>
        </div>
      </div>
    </div>

    <!-- Items Container -->
    <div id="items" class="space-y-6"></div>
  </div>

  <!-- ===== Item Template ===== -->
  <template id="item-tpl">
    <div class="p-4 bg-white rounded-xl border">
      <div class="flex items-start justify-between gap-3">
        <div class="text-lg font-semibold">公告項目</div>
        <button class="btn-remove text-red-600 text-sm hover:underline">刪除此筆</button>
      </div>
      <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="block text-sm font-medium mb-1">ID</label>
          <input class="f-id w-full border rounded px-2 py-1" placeholder="ann-20251005-001" />
          <small class="text-slate-500">只允許小寫英數與連字號，需唯一。</small>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Type</label>
          <select class="f-type w-full border rounded px-2 py-1">
            <option value="promo">promo</option>
            <option value="announce">announce</option>
          </select>
        </div>
        <div class="flex items-center gap-2 mt-6 md:mt-0">
          <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" class="f-pinned"> 置頂</label>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Badge</label>
          <input class="f-badge w-full border rounded px-2 py-1" placeholder="Hot" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Title</label>
          <input class="f-title w-full border rounded px-2 py-1" placeholder="標題" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Period（第一行文字）</label>
          <input class="f-period w-full border rounded px-2 py-1" placeholder="2025/10/01 – 2025/10/31" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">開始日</label>
          <input type="date" class="f-start w-full border rounded px-2 py-1" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">結束日</label>
          <input type="date" class="f-end w-full border rounded px-2 py-1" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">展開按鈕文字</label>
          <input class="f-summary-btn w-full border rounded px-2 py-1" placeholder="查看內容" />
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <div class="flex items-center justify-between mb-1">
            <label class="block text-sm font-medium">第三行(主內容)</label>
            <div class="flex items-center gap-2">
              <label class="text-sm">主內容 格式</label>
              <select class="f-summary-format border rounded px-2 py-1 text-sm">
                <option value="text">純文字（保留換行）</option>
                <option value="html">HTML（支援粗體/顏色/大小/置中）</option>
              </select>
            </div>
          </div>
          <textarea class="f-summary w-full border rounded px-2 py-1 h-28" placeholder="例：<b>粗體</b>、<span style='color:red;font-size:18px;text-align:center;display:block;'>紅 18px 置中</span>、<br>換行"></textarea>
        </div>

        <div>
          <div class="flex items-center justify-between mb-1">
            <label class="block text-sm font-medium">展開內容（每行一點）</label>
            <div class="flex items-center gap-2">
              <label class="text-sm">展開內容 格式</label>
              <select class="f-bullets-format border rounded px-2 py-1 text-sm">
                <option value="text">純文字（保留換行）</option>
                <option value="html">HTML（支援粗體/顏色/大小/置中）</option>
              </select>
            </div>
          </div>
          <textarea class="f-bullets w-full border rounded px-2 py-1 h-28" placeholder="第一行內容
第二行內容
第三行內容"></textarea>
          <small class="block text-slate-500 mt-1">
            HTML 模式支援：&lt;b&gt;、&lt;strong&gt;、&lt;i&gt;、&lt;em&gt;、&lt;u&gt;、&lt;br&gt;、&lt;span style='color|font-size|text-align'&gt;
          </small>
        </div>
      </div>
      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="block text-sm font-medium mb-1">CTA 文字</label>
          <input class="f-cta-text w-full border rounded px-2 py-1" placeholder="立即前往" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-1">CTA 連結</label>
          <input class="f-cta-href w-full border rounded px-2 py-1" placeholder="https://example.com" />
        </div>
      </div>

      <!-- 前台預覽（卡片） -->
      <div class="mt-4 border rounded p-3">
        <div class="text-sm text-slate-500 mb-2">前台預覽（與首頁 #news 卡片一致，預設收合）</div>
        <div class="preview-card"></div>
      </div>
    </div>
  </template>

  <script>
    // ==== State ====
    let items = [];
    const elItems = document.getElementById('items');

    // ==== Toggle GitHub panel ====
    const ghPanel = document.getElementById('gh-panel');
    const btnToggle = document.getElementById('btn-upload-toggle');
    const btnClose = document.getElementById('btn-upload-close');

    function setPanel(open) {
      ghPanel.classList.toggle('hidden', !open);
      btnToggle.setAttribute('aria-expanded', String(open));
      if (open) ghPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
      localStorage.setItem('news-admin-gh-open', open ? '1' : '0');
    }
    btnToggle.addEventListener('click', () => setPanel(ghPanel.classList.contains('hidden')));
    btnClose.addEventListener('click', () => setPanel(false));
    (function initPanelState(){ setPanel(localStorage.getItem('news-admin-gh-open') === '1'); })();
    // ==== Utilities ====
    function uid() {
      if (crypto?.randomUUID) return 'ann-' + crypto.randomUUID();
      return 'ann-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 7);
    }

    function setDirty(v = true) {
      document.getElementById('dirty-ind').classList.toggle('hidden', !v);
      window.__dirty = v;
    }
    window.addEventListener('beforeunload', (e) => { if (window.__dirty) { e.preventDefault(); e.returnValue = ''; } });

    function escapeHTML(s = '') {
      return s
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function base64EncodeUnicode(str) {
      const utf8 = new TextEncoder().encode(str);
      let binary = ''; utf8.forEach(b => binary += String.fromCharCode(b));
      return btoa(binary);
    }

    // === 安全 HTML（僅允許安全標籤） ===
    function sanitizeSummaryHTML(html) {
      const allowed = ['B','STRONG','I','EM','U','BR','SPAN'];
      const tmp = document.createElement('div');
      tmp.innerHTML = html;
      (function walk(node) {
        for (const child of [...node.children]) {
          if (!allowed.includes(child.tagName)) {
            const text = document.createTextNode(child.textContent);
            child.replaceWith(text);
            continue;
          }
          if (child.tagName === 'SPAN') {
            const color = child.style.color;
            const fsize = child.style.fontSize;
            const tAlign = child.style.textAlign;
            child.removeAttribute('style');
            if (color) child.style.color = color;
            if (fsize) child.style.fontSize = fsize;
            if (tAlign) child.style.textAlign = tAlign;
          } else {
            [...child.attributes].forEach(attr => child.removeAttribute(attr.name));
          }
          walk(child);
        }
      })(tmp);
      return tmp.innerHTML;
    }

    function validateAll(items) {
      const idSet = new Set();
      const errors = [];
      const idRe = /^[a-z0-9-]+$/;
      items.forEach((it, idx) => {
        const p = (field) => `第 ${idx+1} 筆（ID: ${it.id || '未填'}）的「${field}」`;
        if (!it.id) errors.push(p('ID') + ' 必填');
        if (it.id && !idRe.test(it.id)) errors.push(p('ID') + ' 僅能包含小寫英數與連字號');
        if (it.id) { if (idSet.has(it.id)) errors.push(p('ID') + ' 重複'); idSet.add(it.id); }
        if (!['promo','announce'].includes(it.type || '')) errors.push(p('Type') + ' 限定 promo/announce');
        if (it.startsAt && !/^\d{4}-\d{2}-\d{2}$/.test(it.startsAt)) errors.push(p('開始日') + ' 格式不正確 (YYYY-MM-DD)');
        if (it.endsAt && !/^\d{4}-\d{2}-\d{2}$/.test(it.endsAt)) errors.push(p('結束日') + ' 格式不正確 (YYYY-MM-DD)');
      });
      return errors;
    }

    // ==== Rendering ====
    function renderItems() {
      elItems.innerHTML = '';
      items.forEach((item, idx) => {
        const tpl = document.getElementById('item-tpl');
        const el = tpl.content.firstElementChild.cloneNode(true);
        const q = (sel) => el.querySelector(sel);
        // ========== 綁定欄位 ==========
        const setVal = (sel, val) => q(sel).value = val ?? '';

        setVal('.f-id', item.id);
        q('.f-id').addEventListener('input', e => { item.id = e.target.value.trim(); setDirty(); });

        q('.f-type').value = item.type || 'promo';
        q('.f-type').addEventListener('change', e => { item.type = e.target.value; setDirty(); renderPreviewFor(el, item); });

        q('.f-pinned').checked = !!item.pinned;
        q('.f-pinned').addEventListener('change', e => { item.pinned = e.target.checked; setDirty(); renderPreviewFor(el, item); });

        setVal('.f-badge', item.badge);
        q('.f-badge').addEventListener('input', e => { item.badge = e.target.value; setDirty(); renderPreviewFor(el, item); });

        setVal('.f-title', item.title);
        q('.f-title').addEventListener('input', e => { item.title = e.target.value; setDirty(); renderPreviewFor(el, item); });

        setVal('.f-period', item.period);
        q('.f-period').addEventListener('input', e => { item.period = e.target.value; setDirty(); renderPreviewFor(el, item); });

        setVal('.f-start', item.startsAt);
        q('.f-start').addEventListener('change', e => { item.startsAt = e.target.value; setDirty(); renderPreviewFor(el, item); });

        setVal('.f-end', item.endsAt);
        q('.f-end').addEventListener('change', e => { item.endsAt = e.target.value; setDirty(); renderPreviewFor(el, item); });

        // Summary
        q('.f-summary-format').value = item.summaryFormat || 'text';
        q('.f-summary-format').addEventListener('change', e => { item.summaryFormat = e.target.value; setDirty(); renderPreviewFor(el, item); });

        setVal('.f-summary', item.summary);
        q('.f-summary').addEventListener('input', e => { item.summary = e.target.value; setDirty(); renderPreviewFor(el, item); });

        // Bullets 支援 HTML ✅
        q('.f-bullets').value = (item.bullets || []).join('\n');
        q('.f-bullets').addEventListener('input', e => {
          const lines = e.target.value.split(/\r?\n/).map(s => s.trim());
          item.bullets = lines.filter(Boolean);
          setDirty(); renderPreviewFor(el, item);
        });

        // ✅ Bullets 格式切換（text / html）
        q('.f-bullets-format').value = item.bulletsFormat || 'text';
        q('.f-bullets-format').addEventListener('change', e => {
          item.bulletsFormat = e.target.value;
          setDirty(); renderPreviewFor(el, item);
        });

        // CTA
        setVal('.f-cta-text', item.cta?.text);
        q('.f-cta-text').addEventListener('input', e => { item.cta = item.cta || {}; item.cta.text = e.target.value; setDirty(); });

        setVal('.f-cta-href', item.cta?.href);
        q('.f-cta-href').addEventListener('input', e => { item.cta = item.cta || {}; item.cta.href = e.target.value; setDirty(); });

        // Remove item
        q('.btn-remove').addEventListener('click', () => {
          if (!confirm('確定刪除此筆？')) return;
          items.splice(idx, 1); setDirty(); renderItems();
        });

        elItems.appendChild(el);
        renderPreviewFor(el, item);
      });
    }

    // ✅ 預覽顯示（含 HTML bullets 支援）
    function renderPreviewFor(el, item) {
      const host = el.querySelector('.preview-card');
      if (!host) return;
      const isHtml = item.summaryFormat === 'html';
      const summary = isHtml ? sanitizeSummaryHTML(item.summary || '') : escapeHTML(item.summary || '').replace(/\n/g, '<br>');

      // ✅ bullets HTML 支援區
      let bulletsHTML = '';
      if (Array.isArray(item.bullets) && item.bullets.length) {
        bulletsHTML = `<ul class="list-disc pl-4 space-y-1 [&>li]:block">` +
          item.bullets.map(line =>
            `<li>${item.bulletsFormat === 'html' ? sanitizeSummaryHTML(line) : escapeHTML(line)}</li>`
          ).join('') +
        `</ul>`;
      }

      host.innerHTML = `
        <article class="rounded border p-3 bg-white shadow">
          <h3 class="font-semibold">${escapeHTML(item.title || '')}</h3>
          <p class="text-sm text-gray-600">${escapeHTML(item.period || '')}</p>
          <div class="mt-2">${summary}</div>
          ${bulletsHTML}
        </article>`;
    }

    renderItems();
  </script>
</body>
</html>
