<!DOCTYPE html>

<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>æœ€æ–°æ¶ˆæ¯ï½œå…¬å‘Šç®¡ç†</title>
<!-- Tailwind CDNï¼ˆé–‹ç™¼/å…§éƒ¨å·¥å…·å¯ç”¨ï¼›ä¸Šç·šè«‹æ”¹ç”¨ç·¨è­¯ç‰ˆï¼‰ -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* è®“ bullets çš„æ¯ä¸€è¡Œéƒ½æ­£ç¢ºé¡¯ç¤ºåœ“é» */
    ul li { display: list-item; }
    details[open] summary { margin-bottom: 0.5rem; }
    code { background: #f1f5f9; padding: 2px 4px; border-radius: 4px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
<div class="max-w-6xl mx-auto p-6 space-y-6">
<h1 class="text-2xl font-bold">æœ€æ–°æ¶ˆæ¯ï½œå…¬å‘Šç®¡ç†å·¥å…·</h1>
<!-- Action Bar -->
<div class="flex flex-wrap gap-2 items-center">
<button class="px-4 py-2 rounded bg-slate-900 text-white hover:bg-slate-800" id="btn-load">
        å¾ä¼ºæœå™¨è¼‰å…¥ /news.json
      </button>
<label class="px-4 py-2 rounded bg-white border cursor-pointer hover:bg-slate-100">
        å¾æœ¬æ©ŸåŒ¯å…¥ JSON
        <input accept="application/json" class="hidden" id="file-input" type="file"/>
</label>
<button class="px-4 py-2 rounded bg-white border hover:bg-slate-100" id="btn-add">
        æ–°å¢ä¸€ç­†
      </button>
<button class="px-4 py-2 rounded bg-white border hover:bg-slate-100" id="btn-download">
        ä¸‹è¼‰ news.json
      </button>
<button aria-controls="gh-panel" aria-expanded="false" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-500" id="btn-upload-toggle">
        ä¸Šå‚³åˆ° GitHub
      </button>
<span class="ml-2 text-xs text-amber-600 hidden" id="dirty-ind">æœ‰æœªå„²å­˜è®Šæ›´</span>
</div>
<!-- GitHub è¨­å®šå€ -->
<div class="hidden p-4 bg-white rounded-xl border" id="gh-panel">
<div class="flex items-center justify-between mb-3">
<div class="text-base font-semibold">ä¸Šå‚³è¨­å®š</div>
<button class="text-sm text-slate-500 hover:underline" id="btn-upload-close">éš±è—</button>
</div>
<div class="grid grid-cols-1 md:grid-cols-5 gap-3">
<div>
<label class="block text-sm font-medium mb-1">Owner</label>
<input class="w-full border rounded px-2 py-1" id="gh-owner" placeholder="your-org-or-user"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">Repo</label>
<input class="w-full border rounded px-2 py-1" id="gh-repo" placeholder="your-repo"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">Branch</label>
<input class="w-full border rounded px-2 py-1" id="gh-branch" value="main"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">Path</label>
<input class="w-full border rounded px-2 py-1" id="gh-path" value="news.json"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">GitHub Token</label>
<div class="relative">
<input class="w-full border rounded px-2 py-1 pr-10" id="gh-token" placeholder="ghp_xxx" type="password"/>
<button class="absolute right-2 top-1/2 -translate-y-1/2 text-sm text-blue-600 hover:underline" id="toggle-token" type="button">é¡¯ç¤º</button>
</div>
</div>
</div>
<div class="mt-3 flex items-center gap-3">
<label class="inline-flex items-center gap-2 text-sm">
<input class="border rounded" id="remember-settings" type="checkbox"/> è¨˜ä½è¨­å®šï¼ˆä¸å« Tokenï¼‰
        </label>
<button class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-500" id="btn-upload">åŸ·è¡Œä¸Šå‚³</button>
<span class="text-sm text-slate-500" id="gh-status"></span>
</div>
</div>
<!-- ğŸ“˜ ä½¿ç”¨æ•™å­¸é¢æ¿ï¼ˆå¯æ”¶åˆï¼‰ -->
<details class="p-4 bg-white rounded-xl border" id="guide-panel">
<summary class="cursor-pointer text-base font-semibold text-blue-700">
        ğŸ“˜ ä½¿ç”¨èªªæ˜èˆ‡ HTML ç·¨è¼¯æ•™å­¸ï¼ˆé»æˆ‘å±•é–‹ï¼‰
      </summary>
<div class="mt-4 space-y-6 text-sm leading-6 text-slate-700">
<!-- Summary æ•™å­¸ -->
<section>
<h3 class="font-semibold text-slate-900 mb-1">â–¶ ä¸»å…§å®¹ Summary ä½¿ç”¨æ–¹å¼</h3>
<p class="mb-2">ä¸»å…§å®¹å¯åˆ‡æ›<strong>[ç´”æ–‡å­—]</strong>æˆ–<strong>[HTML]</strong>æ¨¡å¼ï¼Œç”¨ä¾†å»ºç«‹æ®µè½ã€ç²—é«”ã€æ›è¡Œæˆ–é¡è‰²ã€‚</p>
<div class="rounded border bg-slate-50 p-3 text-xs space-y-1">
<div>ç¯„ä¾‹ï¼š</div>
<div>&lt;b&gt;ç²—é«”æ–‡å­—&lt;/b&gt;</div>
<div>&lt;i&gt;æ–œé«”æ–‡å­—&lt;/i&gt;</div>
<div>&lt;u&gt;åº•ç·šæ–‡å­—&lt;/u&gt;</div>
<div>&lt;br&gt; â† æ›è¡Œ</div>
<div>&lt;span style="color:#e60000"&gt;ç´…è‰²æé†’æ–‡å­—&lt;/span&gt;</div>
<div>&lt;span style="font-size:18px"&gt;æ”¾å¤§æ–‡å­— 18px&lt;/span&gt;</div>
<div>&lt;span style="text-align:center;display:block"&gt;ç½®ä¸­å…§å®¹&lt;/span&gt;</div>
</div>
<p class="mt-1 text-amber-700 text-xs">å®‰å…¨æ€§ï¼šç³»çµ±æœƒè‡ªå‹•ç§»é™¤å±éšªæ¨™ç±¤ï¼ˆå¦‚ <code>&lt;script&gt;</code>ï¼‰ã€‚</p>
</section>
<!-- Bullets æ•™å­¸ -->
<section>
<h3 class="font-semibold text-slate-900 mb-1">â–¶ å±•é–‹å…§å®¹ Bullets ä½¿ç”¨æ–¹å¼</h3>
<p class="mb-2">æ¯è¡Œä»£è¡¨ä¸€å€‹é …ç›®åˆ—ï¼ˆæœƒè‡ªå‹•è®Šæˆã€Œâ€¢ã€ç¬¦è™Ÿï¼‰ã€‚ä¹Ÿæ”¯æ´ HTMLï¼</p>
<div class="rounded border bg-slate-50 p-3 text-xs space-y-1">
<div>ç¯„ä¾‹ï¼š</div>
<div>&lt;b&gt;æ´»å‹•æ™‚é–“&lt;/b&gt;ï¼šå³æ—¥èµ·è‡³ 3/30</div>
<div>&lt;span style="color:#16a34a"&gt;âœ… å…¨é¤¨å…é‹&lt;/span&gt;</div>
<div>&lt;span style="color:#e11d48"&gt;âš  æ•¸é‡æœ‰é™ï¼Œå”®å®Œç‚ºæ­¢&lt;/span&gt;</div>
</div>
</section>
<!-- è‰²ç¥¨ -->
<section>
<h3 class="font-semibold text-slate-900 mb-2">â–¶ å¸¸ç”¨é¡è‰²è¡¨ï¼ˆé»ä¸€ä¸‹è‡ªå‹•è¤‡è£½ HEX è‰²ç¢¼ï¼‰</h3>
<details class="rounded border bg-slate-50">
<summary class="cursor-pointer px-3 py-2">ğŸ¨ å±•é–‹è‰²ç¥¨</summary>
<div class="p-3 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 text-xs">
<!-- è‰²ç¥¨æŒ‰éˆ• -->
<button class="swatch border rounded overflow-hidden" data-hex="#000000">
<div style="background:#000000;height:28px;"></div>
<div class="p-1 flex justify-between"><span>Black</span><code>#000000</code></div>
</button>
<button class="swatch border rounded overflow-hidden" data-hex="#FFFFFF">
<div style="background:#FFFFFF;height:28px;"></div>
<div class="p-1 flex justify-between"><span>White</span><code>#FFFFFF</code></div>
</button>
<button class="swatch border rounded overflow-hidden" data-hex="#EF4444">
<div style="background:#EF4444;height:28px;"></div>
<div class="p-1 flex justify-between"><span>Red</span><code>#EF4444</code></div>
</button>
<button class="swatch border rounded overflow-hidden" data-hex="#F97316">
<div style="background:#F97316;height:28px;"></div>
<div class="p-1 flex justify-between"><span>Orange</span><code>#F97316</code></div>
</button>
<button class="swatch border rounded overflow-hidden" data-hex="#F59E0B">
<div style="background:#F59E0B;height:28px;"></div>
<div class="p-1 flex justify-between"><span>Amber</span><code>#F59E0B</code></div>
</button>
<button class="swatch border rounded overflow-hidden" data-hex="#22C55E">
<div style="background:#22C55E;height:28px;"></div>
<div class="p-1 flex justify-between"><span>Green</span><code>#22C55E</code></div>
</button>
<button class="swatch border rounded overflow-hidden" data-hex="#3B82F6">
<div style="background:#3B82F6;height:28px;"></div>
<div class="p-1 flex justify-between"><span>Blue</span><code>#3B82F6</code></div>
</button>
<button class="swatch border rounded overflow-hidden" data-hex="#A855F7">
<div style="background:#A855F7;height:28px;"></div>
<div class="p-1 flex justify-between"><span>Purple</span><code>#A855F7</code></div>
</button>
<button class="swatch border rounded overflow-hidden" data-hex="#EC4899">
<div style="background:#EC4899;height:28px;"></div>
<div class="p-1 flex justify-between"><span>Pink</span><code>#EC4899</code></div>
</button>
<button class="swatch border rounded overflow-hidden" data-hex="#64748B">
<div style="background:#64748B;height:28px;"></div>
<div class="p-1 flex justify-between"><span>Slate</span><code>#64748B</code></div>
</button>
</div>
<p class="text-slate-500 px-3 pb-2">æç¤ºï¼šå¯ç”¨æ–¼ <code>&lt;span style="color:#HEX"&gt;</code></p>
</details>
</section>
</div>
</details>
<!-- Items Container -->
<div class="space-y-6" id="items"></div>
</div> <!-- end wrapper -->
<!-- å–®ç­† Item æ¨¡æ¿ -->
<template id="item-tpl">
<div class="p-4 bg-white rounded-xl border shadow-sm">
<div class="flex items-start justify-between">
<h2 class="text-lg font-semibold">å…¬å‘Šé …ç›®</h2>
<button class="btn-remove text-red-600 text-sm hover:underline">åˆªé™¤é€™ç­†</button>
</div>
<!-- åŸºæœ¬æ¬„ä½ -->
<div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
<div>
<label class="block text-sm font-medium mb-1">IDï¼ˆå”¯ä¸€ï¼‰</label>
<input class="f-id w-full border rounded px-2 py-1" placeholder="ann-20250101" required="required"/>
<p class="text-xs text-slate-500">å°å¯«è‹±æ–‡ã€æ•¸å­—ã€- çµ„æˆ</p>
</div>
<div>
<label class="block text-sm font-medium mb-1">é¡å‹ type</label>
<select class="f-type w-full border rounded px-2 py-1">
<option value="announce">announce</option>
<option value="promo">promo</option>
</select>
</div>
<div class="flex items-center gap-2 mt-6">
<label class="inline-flex items-center gap-2">
<input class="f-pinned" type="checkbox"/> <span class="text-sm">ç½®é ‚</span>
</label>
</div>
<div>
<label class="block text-sm font-medium mb-1">Badge æ¨™ç±¤ï¼ˆå¯ç©ºï¼‰</label>
<input class="f-badge w-full border rounded px-2 py-1" placeholder="HOT / NEW"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">æ¨™é¡Œ title</label>
<input class="f-title w-full border rounded px-2 py-1" placeholder="å…¬å‘Šæ¨™é¡Œ" required="required"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">Periodï¼ˆæ—¥æœŸé¡¯ç¤ºç”¨å­—ä¸²ï¼‰</label>
<input class="f-period w-full border rounded px-2 py-1" placeholder="2025/02/01 - 2025/02/20"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">é–‹å§‹æ—¥æœŸï¼ˆstartï¼‰</label>
<input class="f-start w-full border rounded px-2 py-1" type="date"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">çµæŸæ—¥æœŸï¼ˆendï¼‰</label>
<input class="f-end w-full border rounded px-2 py-1" type="date"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">å±•é–‹æŒ‰éˆ•æ–‡å­—</label>
<input class="f-summary-btn w-full border rounded px-2 py-1" placeholder="æŸ¥çœ‹å…§å®¹"/>
</div>
</div>
<!-- Summary + Bullets -->
<div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
<!-- Summary -->
<div>
<div class="flex items-center justify-between mb-1">
<label class="block text-sm font-medium">ä¸»å…§å®¹ Summary</label>
<select class="f-summary-format border rounded px-2 py-1 text-sm">
<option value="text">ç´”æ–‡å­—</option>
<option value="html">HTML æ ¼å¼</option>
</select>
</div>
<textarea class="f-summary w-full border rounded px-2 py-2 h-28" placeholder="æ”¯æ´æ›è¡Œã€ç²—é«”ã€é¡è‰²..."></textarea>
</div>
<!-- Bulletsï¼ˆæ”¯æ´ HTMLï¼‰ -->
<div>
<label class="block text-sm font-medium mb-1">å±•é–‹å…§å®¹ Bulletsï¼ˆæ¯è¡Œä¸€é …ï¼‰</label>
<textarea class="f-bullets w-full border rounded px-2 py-2 h-28" placeholder="æ¯ä¸€è¡Œæœƒæ˜¯ä¸€å€‹å°åœ“é»é …ç›®
æ”¯æ´ &lt;b&gt;&lt;/b&gt; &lt;br&gt; &lt;span style='color:red'&gt;&lt;/span&gt;"></textarea>
</div>
</div>
<!-- CTA -->
<div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
<div>
<label class="block text-sm font-medium mb-1">CTA é¡¯ç¤ºæ–‡å­—</label>
<input class="f-cta-text w-full border rounded px-2 py-1" placeholder="äº†è§£æ›´å¤š"/>
</div>
<div class="md:col-span-2">
<label class="block text-sm font-medium mb-1">CTA é€£çµç¶²å€</label>
<input class="f-cta-href w-full border rounded px-2 py-1" placeholder="https://example.com"/>
</div>
</div>
<!-- é è¦½ -->
<div class="mt-6 border rounded p-4 bg-slate-50">
<h3 class="text-sm text-slate-500 mb-2">é è¦½ï¼ˆå‰å°å‘ˆç¾æ–¹å¼æ¨¡æ“¬ï¼‰</h3>
<div class="preview-card text-sm text-slate-800"></div>
</div>
</div>
</template>
<script>
    // -----------------------------
    // ç‹€æ…‹
    // -----------------------------
    let items = [];
    const elItems = document.getElementById('items');

    // æ¯ç­†çš„å±•é–‹ç‹€æ…‹ï¼ˆä¸å¯«å› JSONï¼Œåªåšé è¦½ç”¨ï¼‰
    const expandState = new Map(); // key: item.id, value: boolean

    // -----------------------------
    // GitHub é¢æ¿é–‹é—œ
    // -----------------------------
    const ghPanel = document.getElementById('gh-panel');
    document.getElementById('btn-upload-toggle').addEventListener('click', () => {
      const open = ghPanel.classList.contains('hidden');
      ghPanel.classList.toggle('hidden', !open);
      localStorage.setItem('news-admin-gh-open', open ? '1' : '0');
    });
    document.getElementById('btn-upload-close').addEventListener('click', () => {
      ghPanel.classList.add('hidden');
      localStorage.setItem('news-admin-gh-open', '0');
    });
    // æ¢å¾©é¢æ¿é–‹åˆç‹€æ…‹
    (function initPanel(){
      const open = localStorage.getItem('news-admin-gh-open') === '1';
      ghPanel.classList.toggle('hidden', !open);
    })();

    // -----------------------------
    // Utility
    // -----------------------------
    function uid() {
      if (crypto?.randomUUID) return 'ann-' + crypto.randomUUID();
      return 'ann-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 7);
    }
    function setDirty(v = true) {
      const ind = document.getElementById('dirty-ind');
      if (v) {
        ind.classList.remove('hidden');
        window.onbeforeunload = () => true;
      } else {
        ind.classList.add('hidden');
        window.onbeforeunload = null;
      }
    }

    // å®‰å…¨ HTMLï¼ˆå…è¨±åŸºæœ¬æ¨™ç±¤ï¼‰
    function sanitizeHTML(html) {
      const allowed = ['B','I','U','STRONG','EM','BR','SPAN'];
      const temp = document.createElement('div');
      temp.innerHTML = html;

      (function walk(node) {
        [...node.children].forEach(child => {
          if (!allowed.includes(child.tagName)) {
            // ç§»é™¤æ¨™ç±¤ä¿ç•™æ–‡å­—
            child.replaceWith(...child.childNodes);
          } else if (child.tagName === 'SPAN') {
            // åƒ…å…è¨± color / font-size / text-align
            let style = child.getAttribute('style') || '';
            // ç°¡å–®ç™½åå–®ï¼šæ“·å–å…è¨±å±¬æ€§
            const allow = [];
            const color = style.match(/color\s*:\s*[^;]+/i);
            const fsize = style.match(/font-size\s*:\s*[^;]+/i);
            const align = style.match(/text-align\s*:\s*[^;]+/i);
            if (color) allow.push(color[0]);
            if (fsize) allow.push(fsize[0]);
            if (align) { allow.push(align[0]); if (!/display\s*:\s*block/i.test(style)) allow.push('display:block'); }
            child.setAttribute('style', allow.join(';'));
            // ç§»é™¤å…¶ä»–å±¬æ€§
            [...child.attributes].forEach(a => { if (a.name !== 'style') child.removeAttribute(a.name); });
          } else {
            // é spanï¼Œç§»é™¤æ‰€æœ‰å±¬æ€§
            [...child.attributes].forEach(a => child.removeAttribute(a.name));
          }
          walk(child);
        });
      })(temp);
      return temp.innerHTML;
    }

    // -----------------------------
    // æ¸²æŸ“ Items
    // -----------------------------
    function renderItems() {
  elItems.innerHTML = '';
  items.forEach((item, idx) => {
    const tpl = document.getElementById('item-tpl');
    const node = tpl.content.cloneNode(true);
    const q = sel => node.querySelector(sel);

    // åˆªé™¤
    q('.btn-remove').addEventListener('click', () => {
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™ï¼Ÿ')) {
        items.splice(idx, 1);
        expandState.delete(item.id);
        renderItems();
        setDirty();
      }
    });

    // å¡«å…¥è³‡æ–™
    q('.f-id').value = item.id;
    q('.f-type').value = item.type || 'announce';
    q('.f-pinned').checked = !!item.pinned;
    q('.f-badge').value = item.badge || '';
    q('.f-title').value = item.title || '';
    q('.f-period').value = item.period || '';
    q('.f-start').value = item.startsAt || '';
    q('.f-end').value = item.endsAt || '';
    q('.f-summary-btn').value = item.summaryButtonText || 'æŸ¥çœ‹å…§å®¹';
    q('.f-summary').value = item.summary || '';
    q('.f-summary-format').value = item.summaryFormat || 'text';
    q('.f-bullets').value = (item.bullets || []).join('\n');
    q('.f-cta-text').value = item.cta?.text || '';
    q('.f-cta-href').value = item.cta?.href || '';

    // ç¶äº‹ä»¶
    q('.f-id').addEventListener('input', e => { item.id = e.target.value.trim(); setDirty(); });
    q('.f-type').addEventListener('change', e => { item.type = e.target.value; setDirty(); renderPreview(elItems.lastElementChild || elItems, item); });
    q('.f-pinned').addEventListener('change', e => { item.pinned = e.target.checked; setDirty(); renderPreview(elItems.lastElementChild || elItems, item); });
    q('.f-badge').addEventListener('input', e => { item.badge = e.target.value; setDirty(); renderPreview(elItems.lastElementChild || elItems, item); });
    q('.f-title').addEventListener('input', e => { item.title = e.target.value; setDirty(); renderPreview(elItems.lastElementChild || elItems, item); });
    q('.f-period').addEventListener('input', e => { item.period = e.target.value; setDirty(); renderPreview(elItems.lastElementChild || elItems, item); });
    q('.f-start').addEventListener('change', e => { item.startsAt = e.target.value; setDirty(); renderPreview(elItems.lastElementChild || elItems, item); });
    q('.f-end').addEventListener('change', e => { item.endsAt = e.target.value; setDirty(); renderPreview(elItems.lastElementChild || elItems, item); });
    q('.f-summary-btn').addEventListener('input', e => { item.summaryButtonText = e.target.value; setDirty(); renderPreview(elItems.lastElementChild || elItems, item); });
    q('.f-summary').addEventListener('input', e => { item.summary = e.target.value; setDirty(); renderPreview(elItems.lastElementChild || elItems, item); });
    q('.f-summary-format').addEventListener('change', e => { item.summaryFormat = e.target.value; setDirty(); renderPreview(elItems.lastElementChild || elItems, item); });
    q('.f-bullets').addEventListener('input', e => {
      item.bullets = e.target.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      setDirty(); renderPreview(elItems.lastElementChild || elItems, item);
    });

    q('.f-cta-text').addEventListener('input', e => {
      item.cta = item.cta || {};
      item.cta.text = e.target.value;
      setDirty();
      renderPreview(elItems.lastElementChild || elItems, item);
    });

    q('.f-cta-href').addEventListener('input', e => {
      item.cta = item.cta || {};
      item.cta.href = e.target.value;
      setDirty();
      renderPreview(elItems.lastElementChild || elItems, item);
    });

    elItems.appendChild(node);
    renderPreview(elItems.lastElementChild, item);
  });
}

    // é è¦½å¡ç‰‡ï¼ˆS2 è—è‰²æŒ‰éˆ•å±•é–‹ã€E1 å±•é–‹å€å¡Šã€æŒ‰éˆ•æ–‡å­—ä¾ summaryButtonTextï¼‰
    function renderPreview(hostEl, item) {
      const container = hostEl.querySelector('.preview-card');
      if (!container) return;

      // Summary
      const summary =
        (item.summaryFormat || 'text') === 'html'
          ? sanitizeHTML(item.summary || '')
          : (item.summary || '').replace(/\n/g, '<br>');

      // Bulletsï¼ˆHTML å®‰å…¨ + æ¯è¡Œåœ“é»ï¼‰
      const bulletsHTML = (Array.isArray(item.bullets) && item.bullets.length)
        ? `<ul class="list-disc pl-4 space-y-1 [&>li]:block">
            ${item.bullets.map(x => `<li>${sanitizeHTML(x)}</li>`).join('')}
           </ul>`
        : '';

      // å±•é–‹ç‹€æ…‹ï¼ˆé è¨­é—œé–‰ï¼‰
      const opened = expandState.get(item.id) || false;

      // æŒ‰éˆ•æ–‡å­—ï¼šå„ªå…ˆä½¿ç”¨è¨­å®šï¼Œå¦å‰‡é è¨­ "æŸ¥çœ‹å…§å®¹"
      const baseBtnText = (item.summaryButtonText && item.summaryButtonText.trim()) ? item.summaryButtonText.trim() : 'æŸ¥çœ‹å…§å®¹';
      const btnText = opened ? `ğŸ”¼ ${baseBtnText}ï¼ˆæ”¶åˆï¼‰` : `ğŸ”½ ${baseBtnText}`;

      // CTA
      const ctaHTML = (item.cta && item.cta.href)
        ? `<a class="inline-flex items-center gap-1 text-sm font-medium text-white bg-blue-600 px-3 py-1.5 rounded hover:bg-blue-700 transition"
             href="${item.cta.href}" target="_blank" rel="noopener">${item.cta.text || 'äº†è§£æ›´å¤š'} âœ</a>`
        : '';

      // å±•é–‹å…§å®¹ï¼ˆåƒ…ç•¶ bullets æˆ– CTA å­˜åœ¨æ™‚æ‰é¡¯ç¤ºæŒ‰éˆ•/å€å¡Šï¼‰
      const hasDetails = !!(bulletsHTML || ctaHTML);

      const details = hasDetails ? `
          <!-- P1ï¼šæŒ‰éˆ•åœ¨ Summary ä¸‹æ–¹é å·¦ -->
          <button type="button"
            class="btn-toggle-details mt-3 inline-flex items-center gap-2 text-sm font-medium px-3 py-1.5 rounded
                   bg-blue-600 text-white hover:bg-blue-700 transition">
            ${btnText}
          </button>
          ${opened ? `
            <div class="mt-3 rounded border border-slate-200 bg-slate-50 p-3 space-y-2">
              ${bulletsHTML}
              ${ctaHTML ? `<div class="pt-1">${ctaHTML}</div>` : ''}
            </div>` : ''}` : '';

      const badge = item.badge || (item.type === 'promo' ? 'å„ª' : 'å‘Š');
      const pinned = item.pinned ? '<span class="ml-2 text-xs px-2 py-0.5 rounded bg-amber-600 text-white">PIN</span>' : '';
      const period = item.period ? `<p class="text-sm text-gray-700">${item.period}</p>` : '';
      const title = item.title || '';

      container.innerHTML = `
<article class="rounded-lg border border-amber-200 bg-white p-4 md:p-5 shadow">
  <div class="flex items-center gap-2 mb-2">
    <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-amber-600 text-white text-xs">${badge}</span>
    <h3 class="font-bold text-gray-900">${title}</h3>
    ${pinned}
  </div>
  ${period}
  ${(item.summary || '').trim()
    ? ((item.summaryFormat || 'text') === 'html'
        ? `<div class="mt-2 text-sm text-gray-700">${summary}</div>`
        : `<p class="mt-2 text-sm text-gray-700" style="white-space:pre-line">${item.summary}</p>`)
    : ''}
  ${details}
</article>`;

      // ç¶å®šå±•é–‹æŒ‰éˆ•
      const btn = container.querySelector('.btn-toggle-details');
      if (btn) {
        btn.addEventListener('click', () => {
          const now = !!expandState.get(item.id);
          expandState.set(item.id, !now);
          renderPreview(hostEl, item);
        });
      }
    }

    // -----------------------------
    // è¼‰å…¥ / åŒ¯å…¥ / ä¸‹è¼‰ / æ–°å¢
    // -----------------------------
    document.getElementById('btn-load').addEventListener('click', async () => {
      try {
        const res = await fetch('news.json?ts=' + Date.now());
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error('JSON å¿…é ˆæ˜¯é™£åˆ—');
        items = data;
        expandState.clear();
        renderItems();
        setDirty(false);
      } catch (err) {
        alert('è¼‰å…¥å¤±æ•—ï¼š' + err.message);
      }
    });

    document.getElementById('file-input').addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        items = JSON.parse(text);
        expandState.clear();
        renderItems();
        setDirty();
      } catch (err) {
        alert('åŒ¯å…¥å¤±æ•—ï¼š' + err.message);
      }
      e.target.value = '';
    });

    document.getElementById('btn-download').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(items, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'news.json';
      a.click();
      URL.revokeObjectURL(url);
      setDirty(false);
    });

    document.getElementById('btn-add').addEventListener('click', () => {
      const it = {
        id: uid(),
        type: 'announce',
        pinned: false,
        badge: '',
        title: '',
        period: '',
        startsAt: '',
        endsAt: '',
        summaryButtonText: 'æŸ¥çœ‹å…§å®¹',
        summaryFormat: 'text',
        summary: '',
        bullets: [],
        cta: { text: '', href: '' }
      };
      items.unshift(it);
      renderItems();
      setDirty();
    });

    // -----------------------------
    // è‰²ç¥¨é»æ“Šè¤‡è£½ HEX
    // -----------------------------
    document.addEventListener('click', async e => {
      const sw = e.target.closest('.swatch');
      if (!sw) return;
      const hex = sw.dataset.hex;
      if (!hex) return;
      try {
        await navigator.clipboard.writeText(hex);
        const codeEl = sw.querySelector('code');
        const old = codeEl?.textContent || hex;
        if (codeEl) {
          codeEl.textContent = 'Copied!';
          setTimeout(() => codeEl.textContent = old, 800);
        }
      } catch {
        alert('ç„¡æ³•è¤‡è£½ï¼Œè«‹æ‰‹å‹•è¤‡è£½: ' + hex);
      }
    });

    // -----------------------------
    // GitHub ä¸Šå‚³
    // -----------------------------
    const ghOwner = document.getElementById('gh-owner');
    const ghRepo = document.getElementById('gh-repo');
    const ghBranch = document.getElementById('gh-branch');
    const ghPath = document.getElementById('gh-path');
    const ghToken = document.getElementById('gh-token');
    const ghStatus = document.getElementById('gh-status');
    const remember = document.getElementById('remember-settings');

    (function loadRemembered(){
      const raw = localStorage.getItem('news-admin-gh');
      if (!raw) return;
      try {
        const s = JSON.parse(raw);
        ghOwner.value = s.owner || '';
        ghRepo.value = s.repo || '';
        ghBranch.value = s.branch || 'main';
        ghPath.value = s.path || 'news.json';
        remember.checked = true;
      } catch {}
    })();

    remember.addEventListener('change', () => {
      if (remember.checked) {
        const s = { owner: ghOwner.value.trim(), repo: ghRepo.value.trim(), branch: ghBranch.value.trim(), path: ghPath.value.trim() };
        localStorage.setItem('news-admin-gh', JSON.stringify(s));
      } else {
        localStorage.removeItem('news-admin-gh');
      }
    });

    ['input','change'].forEach(ev => {
      [ghOwner, ghRepo, ghBranch, ghPath].forEach(el => el.addEventListener(ev, () => {
        if (!remember.checked) return;
        const s = { owner: ghOwner.value.trim(), repo: ghRepo.value.trim(), branch: ghBranch.value.trim(), path: ghPath.value.trim() };
        localStorage.setItem('news-admin-gh', JSON.stringify(s));
      }));
    });

    document.getElementById('toggle-token').addEventListener('click', () => {
      const isHidden = ghToken.type === 'password';
      ghToken.type = isHidden ? 'text' : 'password';
      document.getElementById('toggle-token').textContent = isHidden ? 'éš±è—' : 'é¡¯ç¤º';
    });
    // è¨˜ä½ Tokenï¼ˆå¯ç§»é™¤ï¼‰
    ghToken.value = localStorage.getItem('news-admin-gh-token') || '';
    ghToken.addEventListener('input', () => {
      localStorage.setItem('news-admin-gh-token', ghToken.value.trim());
    });

    async function githubRequest(path, method = 'GET', body) {
      const token = ghToken.value.trim();
      if (!token) throw new Error('è«‹å…ˆè¼¸å…¥ GitHub Token');
      const res = await fetch(`https://api.github.com${path}`, {
        method,
        headers: {
          'Accept': 'application/vnd.github+json',
          'Authorization': `Bearer ${token}`
        },
        body: body ? JSON.stringify(body) : undefined
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(`GitHub ${res.status}: ${t}`);
      }
      return res.json();
    }

    async function getFileSHA(owner, repo, branch, path) {
      try {
        const data = await githubRequest(`/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`);
        return data.sha;
      } catch (e) {
        return null;
      }
    }

    document.getElementById('btn-upload').addEventListener('click', async () => {
      const owner = ghOwner.value.trim();
      const repo = ghRepo.value.trim();
      const branch = ghBranch.value.trim() || 'main';
      const path = ghPath.value.trim() || 'news.json';
      ghStatus.textContent = 'æª¢æŸ¥ä¸­â€¦';

      try {
        const sha = await getFileSHA(owner, repo, branch, path);
        ghStatus.textContent = 'ä¸Šå‚³ä¸­â€¦';
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(items, null, 2))));
        const message = `chore(news): update news.json @ ${new Date().toISOString()}`;
        const body = { message, content, branch };
        if (sha) body.sha = sha;
        await githubRequest(`/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`, 'PUT', body);
        ghStatus.textContent = 'âœ… ä¸Šå‚³å®Œæˆ';
        setDirty(false);
      } catch (e) {
        ghStatus.textContent = 'âŒ å¤±æ•—';
        alert('ä¸Šå‚³å¤±æ•—ï¼š' + e.message + '\n\nå¸¸è¦‹åŸå› ï¼š\n- Token æ¬Šé™ä¸è¶³ï¼ˆContents: Read & writeï¼‰æˆ– SSO æœªæˆæ¬Š\n- Owner/Repo/Branch/Path éŒ¯èª¤\n- åˆ†æ”¯ä¿è­·è¦å‰‡é˜»æ“‹ç›´æ¥å¯«å…¥');
      }
    });

    // åˆå§‹åŒ–
    renderItems();
  </script>
</body>
</html>
