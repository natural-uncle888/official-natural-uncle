<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <!-- 新增 favicon -->
  <link rel="icon" href="https://res.cloudinary.com/dijzndzw2/image/upload/v1757176751/logo-3_hddq08.png" type="image/png"/>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>最新消息｜公告管理</title>
  <script src="https://cdn.tailwindcss.com"></script>
<script defer>
// === injected: loader & downloader ===
    async function loadFromServer(){
      try{
        const url = (window.NEWS_JSON_URL || '/news.json') + (window.NEWS_JSON_URL?.includes('?') ? '&' : '?') + 't=' + Date.now();
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        if(!Array.isArray(data)) throw new Error('資料格式需為陣列');
        items = data;
        render();
        alert('已載入 ' + url + '，共 ' + items.length + ' 筆');
      }catch(err){
        alert('載入失敗：' + err.message + '\n\n可能原因：\n1) 路徑錯誤（請確認 news.json 與此頁是否同網域/路徑）\n2) CORS 限制（跨網域需開放 Access-Control-Allow-Origin）\n3) 檔案內容不是 JSON 陣列');
      }
    }
    function downloadJson(){
      try{
        const blob = new Blob([JSON.stringify(items, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'news.json';
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{
          URL.revokeObjectURL(a.href);
          a.remove();
        }, 0);
      }catch(err){
        alert('下載失敗：' + err.message);
      }
    }
    

// === injected: GitHub upload ===
(function(){
  function toB64(str){
    const utf8 = new TextEncoder().encode(str);
    let binary = '';
    for (let i=0;i<utf8.length;i++) binary += String.fromCharCode(utf8[i]);
    return btoa(binary);
  }
  async function ghFetch(url, opts){
    const res = await fetch(url, opts);
    const txt = await res.text();
    let data = null;
    try { data = JSON.parse(txt); } catch {}
    if(!res.ok){
      const msg = (data && (data.message || data.error)) || txt || res.statusText;
      throw new Error(`GitHub API ${res.status}: ${msg}`);
    }
    return data ?? {};
  }
  async function uploadNewsToGitHub(){
    const status = document.getElementById('ghStatus');
    const owner  = document.getElementById('ghOwner').value.trim();
    const repo   = document.getElementById('ghRepo').value.trim();
    const branch = document.getElementById('ghBranch').value.trim() || 'main';
    const path   = document.getElementById('ghPath').value.trim() || 'news.json';
    const token  = document.getElementById('ghToken').value.trim();
    const message= document.getElementById('ghMessage').value.trim() || 'chore(news): update news.json';
    if(!owner || !repo || !token){
      status.textContent = '請填寫 owner / repo / token';
      status.className = 'text-sm text-red-600';
      return;
    }
    status.textContent = '讀取現有檔案狀態...';
    status.className = 'text-sm text-slate-600';
    const base = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
    const headers = {
      'Accept': 'application/vnd.github+json',
      'Authorization': `Bearer ${token}`,
      'X-GitHub-Api-Version': '2022-11-28'
    };
    // get sha if exists
    let sha;
    try {
      const meta = await ghFetch(base + `?ref=${encodeURIComponent(branch)}`, { headers });
      sha = meta.sha;
    } catch(e){
      if(!/404/.test(String(e))) {
        status.textContent = e.message;
        status.className = 'text-sm text-red-600';
        return;
      }
    }
    // prepare content
    let jsonStr = '';
    try{
      jsonStr = JSON.stringify(items, null, 2);
    }catch(e){
      status.textContent = '無法序列化 items：' + e.message;
      status.className = 'text-sm text-red-600';
      return;
    }
    // upload
    status.textContent = '上傳中...';
    try {
      const body = { message, content: toB64(jsonStr), branch };
      if(sha) body.sha = sha;
      const result = await ghFetch(base, { method: 'PUT', headers, body: JSON.stringify(body) });
      status.innerHTML = `✅ 已提交：<a class="underline" target="_blank" href="${result.commit?.html_url || '#'}">查看 commit</a>`;
      status.className = 'text-sm text-emerald-600';
    } catch(e){
      status.textContent = '上傳失敗：' + e.message;
      status.className = 'text-sm text-red-600';
    }
  }
  const btn = document.getElementById('btnGhUpload');
  if(btn) btn.addEventListener('click', (e)=>{ e.preventDefault(); uploadNewsToGitHub(); });
})();


// === injected: GitHub prefs persistence (localStorage, excludes token) ===
(function(){
  const KEY = 'newsGhPrefs.v1';
  function loadPrefs(){
    try{ return JSON.parse(localStorage.getItem(KEY) || 'null') || null; }catch{return null;}
  }
  function savePrefs(obj){
    try{ localStorage.setItem(KEY, JSON.stringify(obj)); }catch{ /* quota or disabled */ }
  }
  function clearPrefs(){
    try{ localStorage.removeItem(KEY); }catch{}
  }
  function readUI(){
    return {
      owner:  document.getElementById('ghOwner')?.value?.trim() || '',
      repo:   document.getElementById('ghRepo')?.value?.trim() || '',
      branch: document.getElementById('ghBranch')?.value?.trim() || 'main',
      path:   document.getElementById('ghPath')?.value?.trim() || 'news.json',
      message:document.getElementById('ghMessage')?.value?.trim() || ''
    };
  }
  function writeUI(p){
    if(!p) return;
    if(p.owner && document.getElementById('ghOwner'))  document.getElementById('ghOwner').value = p.owner;
    if(p.repo && document.getElementById('ghRepo'))    document.getElementById('ghRepo').value = p.repo;
    if(p.branch && document.getElementById('ghBranch'))document.getElementById('ghBranch').value = p.branch;
    if(p.path && document.getElementById('ghPath'))    document.getElementById('ghPath').value = p.path;
    if(p.message && document.getElementById('ghMessage'))document.getElementById('ghMessage').value = p.message;
  }

  function maybeAutoSave(){
    const remember = document.getElementById('ghRemember');
    if(remember && remember.checked){
      const prefs = readUI();
      savePrefs({ ...prefs, _ts: Date.now() });
    }
  }

  // On load, populate fields
  window.addEventListener('DOMContentLoaded', ()=>{
    const remember = document.getElementById('ghRemember');
    const clearBtn = document.getElementById('btnGhClear');
    const inputs = ['ghOwner','ghRepo','ghBranch','ghPath','ghMessage'].map(id=>document.getElementById(id)).filter(Boolean);
    const prefs = loadPrefs();
    if(prefs){
      writeUI(prefs);
      if(remember) remember.checked = true;
    }

    // save on input if remember checked
    inputs.forEach(inp=>{
      inp.addEventListener('input', maybeAutoSave);
      inp.addEventListener('change', maybeAutoSave);
    });

    if(remember){
      remember.addEventListener('change', ()=>{
        if(remember.checked){
          maybeAutoSave();
        }else{
          clearPrefs();
        }
      });
    }
    if(clearBtn){
      clearBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        clearPrefs();
        if(remember) remember.checked = false;
        // also clear UI values? No, keep what's typed.
        const s = document.getElementById('ghStatus');
        if(s){ s.textContent = '已清除保存的欄位（Token 本來就不會保存）'; s.className='text-sm text-slate-600'; }
      });
    }
  });
})();
</script>

  <style>
    .badge{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:9999px;background:#f59e0b;color:#fff;font-size:12px}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-5xl mx-auto p-4 md:p-6">
    <h1 class="text-2xl md:text-3xl font-extrabold">最新消息｜公告管理</h1>
    <p class="text-sm text-slate-600 mt-1">純前端管理。編輯完成後按「下載」產出新的 <code class="mono">news.json</code> 進行部署。</p>

    <div class="mt-4 flex flex-wrap gap-2">
      <button id="btnLoad" class="px-3 py-2 rounded bg-blue-600 text-white text-sm hover:bg-blue-700">載入伺服器上的 news.json</button>
      <label class="px-3 py-2 rounded bg-slate-200 text-slate-800 text-sm hover:bg-slate-300 cursor-pointer">
        從本機匯入 news.json
        <input id="fileInput" type="file" accept="application/json" class="hidden"/>
      </label>
      <button id="btnAdd" class="px-3 py-2 rounded bg-emerald-600 text-white text-sm hover:bg-emerald-700">新增一筆</button>
      <button id="btnDownload" class="px-3 py-2 rounded bg-amber-600 text-white text-sm hover:bg-amber-700">下載更新後的 news.json</button>
    </div>

    <!-- GitHub 一鍵上傳（前端直連 GitHub API） -->
    <details class="mt-4 bg-white border rounded-xl p-4">
      <summary class="cursor-pointer text-sm font-medium text-slate-700">一鍵上傳到 GitHub（無需後端）</summary>
      <div class="grid md:grid-cols-3 gap-3 mt-3">
        <div class="space-y-1">
          <label class="block text-xs text-slate-600">擁有者 owner（個人帳號或 org）</label>
          <input id="ghOwner" class="w-full border rounded px-2 py-1 text-sm" placeholder="your-username">
        </div>
        <div class="space-y-1">
          <label class="block text-xs text-slate-600">Repository</label>
          <input id="ghRepo" class="w-full border rounded px-2 py-1 text-sm" placeholder="your-repo">
        </div>
        <div class="space-y-1">
          <label class="block text-xs text-slate-600">分支 branch</label>
          <input id="ghBranch" class="w-full border rounded px-2 py-1 text-sm" placeholder="main" value="main">
        </div>
        <div class="space-y-1 md:col-span-2">
          <label class="block text-xs text-slate-600">檔案路徑（repo 內）</label>
          <input id="ghPath" class="w-full border rounded px-2 py-1 text-sm mono" placeholder="news.json" value="news.json">
        </div>
        <div class="space-y-1">
          <label class="block text-xs text-slate-600">個人存取權杖 PAT（僅 contents 權限）</label>
          <input id="ghToken" type="password" class="w-full border rounded px-2 py-1 text-sm" placeholder="ghp_...">
        </div>
        <div class="space-y-1 md:col-span-3">
          <label class="block text-xs text-slate-600">Commit 訊息</label>
          <input id="ghMessage" class="w-full border rounded px-2 py-1 text-sm" placeholder="chore(news): update news.json">
        </div>
      </div>
      <div class="mt-3 flex items-center gap-3">
        <label class="text-sm text-slate-700 inline-flex items-center gap-2 select-none"><input id="ghRemember" type="checkbox" class="align-middle"> 保存資料（不含 Token）</label>
        <button id="btnGhUpload" class="px-3 py-2 rounded bg-neutral-800 text-white text-sm hover:bg-neutral-900">上傳 news.json 到 GitHub</button>
        <button id="btnGhClear" class="px-3 py-2 rounded border text-sm hover:bg-slate-50">清除保存</button>
        <span id="ghStatus" class="text-sm text-slate-600"></span>
      </div>
      <p class="mt-2 text-xs text-slate-500">⚠️ 安全性提醒：瀏覽器無法安全保存金鑰，請勿勾選「記住密碼」。此工具僅在你當前瀏覽器記憶體中使用 Token，不寫入 localStorage。</p>
    <p class="mt-2 text-xs text-slate-500">⚠️ 我們不會保存 Token；若勾選保存，欄位會存於此瀏覽器的 localStorage。</p>
    </details>



    <details class="mt-4 bg-white rounded-xl border p-3" open>
      <summary class="font-bold cursor-pointer">欄位說明</summary>
      <ul class="list-disc pl-6 text-sm text-slate-700 mt-2 space-y-1">
        <li><code class="mono">startsAt</code>/<code class="mono">endsAt</code> 控制顯示時間窗（YYYY-MM-DD）。</li>
        <li><code class="mono">summaryButtonText</code> 可自訂前台展開按鈕文字（預設「查看內容」）。</li>
      </ul>
    </details>

    <div id="list" class="mt-4 space-y-3"></div>
        <!-- 即時預覽區 -->
        <div id="previewPane" class="mt-6 bg-white rounded-xl border p-4">
          <div class="flex items-center justify-between">
            <h2 class="font-bold">即時預覽</h2>
            <span id="previewHint" class="text-xs text-slate-500">點每一筆的「預覽」或在該筆輸入框輸入時自動更新</span>
          </div>
          <div id="preview" class="mt-3 text-sm text-slate-800">
            <p class="text-slate-500 text-sm">尚未選擇預覽項目。</p>
          </div>
        </div>

        <!-- 預覽模板（模擬前台卡片樣式） -->
        <template id="previewTpl">
          <div class="border rounded-lg p-4">
            <div class="flex items-center gap-2 mb-2">
              <span class="badge"></span>
              <span class="text-xs px-2 py-0.5 rounded-full bg-slate-100" data-field="type"></span>
            </div>
            <h3 class="text-lg font-bold mb-1" data-field="title"></h3>
            <div class="text-xs text-slate-500 mb-2" data-field="period"></div>
            <div class="prose prose-sm max-w-none">
              <p data-field="summary"></p>
              <ul class="list-disc pl-5 space-y-1" data-field="bullets"></ul>
            </div>
            <div class="mt-3">
              <a data-field="cta" class="inline-block px-3 py-1 rounded bg-blue-600 text-white text-sm hover:bg-blue-700" target="_blank" rel="noopener"></a>
            </div>
          </div>
        </template>
        
  </div>

  <template id="rowTpl">
    <div class="bg-white rounded-xl border p-4">
      <div class="flex items-center gap-2">
        <span class="badge">告</span>
        <input data-field="title" class="flex-1 border rounded px-2 py-1 text-sm" placeholder="標題">
        <label class="text-sm flex items-center gap-1">
          <input type="checkbox" data-field="pinned"> 置頂
        </label>
        <button data-action="preview" class="text-sm px-2 py-1 rounded border border-slate-400 hover:bg-slate-50">預覽</button>
        <button data-action="delete" class="ml-auto text-sm px-2 py-1 rounded border border-red-600 text-red-700 hover:bg-red-50">刪除</button>
      </div>

      <div class="grid md:grid-cols-2 gap-3 mt-3">
        <div class="space-y-2">
          <label class="block text-xs text-slate-600">ID</label>
          <input data-field="id" class="w-full border rounded px-2 py-1 text-sm mono" placeholder="唯一識別，例如 promo-202509">
        </div>
        <div class="space-y-2">
          <label class="block text-xs text-slate-600">類型 type（promo/announce）</label>
          <input data-field="type" class="w-full border rounded px-2 py-1 text-sm" placeholder="promo 或 announce">
        </div>
        <div class="space-y-2">
          <label class="block text-xs text-slate-600">徽章文字 badge</label>
          <input data-field="badge" class="w-full border rounded px-2 py-1 text-sm" placeholder="告、優…">
        </div>
        <div class="space-y-2">
          <label class="block text-xs text-slate-600">顯示期間 period（純文字）</label>
          <input data-field="period" class="w-full border rounded px-2 py-1 text-sm" placeholder="2025/09/10 – 2025/09/30">
        </div>
        <div class="space-y-2">
          <label class="block text-xs text-slate-600">startsAt（YYYY-MM-DD）</label>
          <input data-field="startsAt" class="w-full border rounded px-2 py-1 text-sm" placeholder="2025-09-10">
        </div>
        <div class="space-y-2">
          <label class="block text-xs text-slate-600">endsAt（YYYY-MM-DD）</label>
          <input data-field="endsAt" class="w-full border rounded px-2 py-1 text-sm" placeholder="2025-09-30">
        </div>
        <div class="space-y-2 md:col-span-2">
          <label class="block text-xs text-slate-600">展開按鈕文字 summaryButtonText</label>
          <input data-field="summaryButtonText" class="w-full border rounded px-2 py-1 text-sm" placeholder="例如：查看優惠、詳細內容、更多資訊">
        </div>
        <div class="md:col-span-2 space-y-2">
          <label class="block text-xs text-slate-600">摘要 summary</label>
          <textarea data-field="summary" class="w-full border rounded px-2 py-1 text-sm" rows="2" placeholder="簡短說明"></textarea>
        </div>
        <div class="md:col-span-2 space-y-2">
          <label class="block text-xs text-slate-600">條列 bullets（每行一項）</label>
          <textarea data-field="bullets" class="w-full border rounded px-2 py-1 text-sm mono" rows="3" placeholder="到府專業清洗\n使用環保清潔劑"></textarea>
        </div>
        <div class="space-y-2">
          <label class="block text-xs text-slate-600">CTA 文字</label>
          <input data-field="ctaText" class="w-full border rounded px-2 py-1 text-sm" placeholder="LINE 聯繫">
        </div>
        <div class="space-y-2">
          <label class="block text-xs text-slate-600">CTA 連結</label>
          <input data-field="ctaHref" class="w-full border rounded px-2 py-1 text-sm" placeholder="https://line.me/...">
        </div>
      </div>
    </div>
  </template>

  <script>
    const $ = s => document.querySelector(s);
    const listEl = $('#list');
    const tpl = $('#rowTpl');
    let items = [];

    
    function render(){
      listEl.innerHTML = '';
      if(!items.length){
        listEl.innerHTML = '<p class="text-sm text-slate-600">目前沒有資料，請點「新增一筆」或「載入」。</p>';
        // 清空預覽
        document.getElementById('preview').innerHTML = '<p class="text-slate-500 text-sm">尚未選擇預覽項目。</p>';
        return;
      }

      // 置頂排序：pinned=true 的先顯示；其餘維持原順序（瀏覽器 sort 穩定）
      const sorted = items.slice().sort((a,b)=> (b.pinned===true) - (a.pinned===true));

      sorted.forEach((it, idxSorted) => {
        const realIdx = items.indexOf(it);
        const node = tpl.content.cloneNode(true);

        // 填值
        node.querySelector('[data-field="title"]').value = it.title || '';
        node.querySelector('[data-field="id"]').value = it.id || '';
        node.querySelector('[data-field="type"]').value = it.type || 'announce';
        node.querySelector('[data-field="badge"]').value = it.badge || '';
        node.querySelector('[data-field="period"]').value = it.period || '';
        node.querySelector('[data-field="startsAt"]').value = it.startsAt || '';
        node.querySelector('[data-field="endsAt"]').value = it.endsAt || '';
        node.querySelector('[data-field="summaryButtonText"]').value = it.summaryButtonText || '';
        node.querySelector('[data-field="summary"]').value = it.summary || '';
        node.querySelector('[data-field="bullets"]').value = (it.bullets||[]).join('\n');
        node.querySelector('[data-field="ctaText"]').value = it.cta?.text || '';
        node.querySelector('[data-field="ctaHref"]').value = it.cta?.href || '';
        node.querySelector('[data-field="pinned"]').checked = !!it.pinned;
        node.querySelector('.badge').textContent = it.badge || '告';

        // 即時雙向綁定（若此筆正在預覽，也同步刷新預覽）
        node.querySelectorAll('[data-field]').forEach(inp=>{
          inp.addEventListener('input',(e)=>{
            const f = inp.getAttribute('data-field');
            const v = inp.value;
            const t = items[realIdx];
            if(f==='title') t.title = v;
            if(f==='id') t.id = v;
            if(f==='type') t.type = v;
            if(f==='badge'){ t.badge = v; /* 更新徽章顯示 */ }
            if(f==='period') t.period = v;
            if(f==='startsAt') t.startsAt = v;
            if(f==='endsAt') t.endsAt = v;
            if(f==='summaryButtonText') t.summaryButtonText = v;
            if(f==='summary') t.summary = v;
            if(f==='bullets') t.bullets = v.split('\n').filter(x=>x.trim().length);
            if(f==='ctaText'){ t.cta = t.cta || {}; t.cta.text = v; }
            if(f==='ctaHref'){ t.cta = t.cta || {}; t.cta.href = v; }
            if(currentPreviewIndex === realIdx){ renderPreview(realIdx); }
          });
        });
        node.querySelector('[data-field="pinned"]').addEventListener('change',(e)=>{
          items[realIdx].pinned = e.target.checked;
          render(); // 重新渲染以套用排序
          if(currentPreviewIndex === realIdx){ renderPreview(realIdx); }
        });

        // 預覽按鈕
        const prevBtn = node.querySelector('[data-action="preview"]');
        if(prevBtn){
          prevBtn.addEventListener('click', ()=>{
            currentPreviewIndex = realIdx;
            renderPreview(realIdx);
          });
        }

        // 刪除按鈕
        node.querySelector('[data-action="delete"]').addEventListener('click', ()=>{
          if(confirm('確定刪除這一筆嗎？')){
            items.splice(realIdx, 1);
            if(currentPreviewIndex === realIdx){ currentPreviewIndex = null; }
            render();
          }
        });

        listEl.appendChild(node);
      });
    }
    function addItem(){
      items.unshift({
        id: 'ann-' + Date.now(),
        type: 'announce',
        badge: '告',
        title: '',
        period: '',
        summaryButtonText: '查看內容',
        summary: '',
        bullets: [],
        cta: { text:'', href:'' },
        pinned: false,
        startsAt: '',
        endsAt: ''
      });
      render();
    }

    function importLocal(file){
      const reader = new FileReader();
      reader.onload = e => {
        try{
          const data = JSON.parse(e.target.result);
          if(!Array.isArray(data)) throw new Error('格式應為陣列');
          items = data;
          render();
        }catch(err){
          alert('匯入失敗：' + err.message);
        }
      };
      reader.readAsText(file, 'utf-8');
    }

    document.getElementById('btnLoad').addEventListener('click', loadFromServer);
    document.getElementById('btnDownload').addEventListener('click', downloadJson);
    document.getElementById('btnAdd').addEventListener('click', addItem);
    document.getElementById('fileInput').addEventListener('change', (e)=>{
      const f = e.target.files?.[0];
      if(f) importLocal(f);
      e.target.value='';
    });
  </script>
</body>
</html>
